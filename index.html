<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        #editor-root {
            border: 1px solid #ccc;
            padding: 1rem;
        }
        #repl {
            width: 40rem;
            height: 20rem;
        }
        #editor-console {
            font-family: monospace;
            border: 1px solid gold;
            list-style: none;
            li {
                border: 1px solid black;
                border-width: 1px 0 0 0;
                padding: 0.5rem;
                &.error {
                    color: red;
                }
            }
            overflow: auto;
            max-height: 20rem;
            height: 15rem;
        }
        #editor-content {
            height: 15rem;
        }
        .hbox, .vbox {
            border: 1px solid red;
            display: flex;
        }
        .hbox {
            flex-direction: row;
        }
        .vbox {
            flex-direction: column;
            max-height: 10rem;
            min-width: 10rem;
        }
        .scroll {
            overflow: scroll;
        }
        ul {
            border: 1px solid red;
            list-style: none;
            margin: 0;
            padding: 0;
            li {
                padding: 0.25rem 0.5rem;
                background-color: #fff;
                &:hover {
                    background-color: #cccccc;
                }
                &.selected {
                    background-color: mediumaquamarine;
                }
                &.selected:hover {
                    background-color: aquamarine;
                }
            }
        }
        .source {
            font-family: monospace;
            white-space: pre;
            padding: 0.5rem;
            overflow: scroll;
            max-height: 10rem;
        }
    </style>
</head>
<body>

<h1>Smalltalk Browser Demo</h1>

<textarea id="repl"></textarea>

<script type="module">
    import {NilObj} from "./src/obj.ts";
    import {JoshLogger} from "./src/util.ts";
    import {eval_ast, eval_statements} from "./src/eval.ts";
    import {make_browser_scope} from "./src/browser.ts";
    import {parse} from "./src/parser.ts";

    let scope = make_browser_scope(document);

    const $ = (sel) => document.querySelector(sel)
    const on = (el,type,cb) => el.addEventListener(type,cb)
    const d = new JoshLogger()

    function output(out) {
        const li = document.createElement('li')
        console.log("typeof last is " + typeof out)
        console.log("typeof last is " + out instanceof Error)
        if (Error.isError(out)) {
            li.innerText = out.message
            li.classList.add('error')
        } else if(out.is_kind_of('NumberProto')) {
            li.innerText = "Number: " + out._get_js_number()
            li.classList.add('number')
        } else if(out.is_kind_of('StringProto')) {
            li.innerText = "String: " + out._get_js_string()
            li.classList.add('string')
        } else {
            li.innerText = "Object: " + out.print()
            li.classList.add('object')
        }
        const cons = $("#editor-console")
        cons.append(li)
        cons.scrollTop = cons.scrollHeight

    }
    function eval_it(code, scope) {
        d.disable()
        d.p('=========')
        d.p(`code is '${code}'`)
        try {
            let ret = eval_statements(code,scope)
            d.p("returned", ret)
            output(ret)
        } catch (e) {
            console.log("error happened",e.name, e.type,e.message)
            output(e)
        }
    }

    eval_statements(`
        dom := DomProxy clone.
        dom init.
        button := (dom makeButton: "hi there").
        Debug print: 'here'.
        dom append: button.
        Global makeSlot: "dom" with: dom.
    `,scope)

    on($("#repl"),'change',() => {
        // console.log("repl changed")
    })
    on($("#repl"),'input',(e) => {
        // console.log("repl input",e)
    })
    on($("#repl"),'keydown',(e) => {
        if(e.key === 'Enter' && e.metaKey) {
            const textArea = $("#repl")
            const selectionStart = textArea.selectionStart;
            const selectionEnd = textArea.selectionEnd;
            const selectedText = textArea.value.substring(selectionStart, selectionEnd);
            console.log("executing", selectedText)
            eval_it(selectedText, scope)
        }
    })
</script>
</body>
</html>