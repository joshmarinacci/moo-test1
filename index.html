<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        #editor-root {
            border: 1px solid #ccc;
            padding: 1rem;
        }
        #repl {
            width: 40rem;
            height: 10rem;
        }
        #editor-console {
            font-family: monospace;
            border: 1px solid gold;
            list-style: none;
            li {
                border: 0px solid red;
                padding: 0.5rem;
            }
            overflow: auto;
            max-height: 20rem;
        }
    </style>
</head>
<body>

<h1>Smalltalk Browser Demo</h1>

<textarea id="repl"></textarea>

<script type="module">
    import {parseBlockBody} from "./src/parser.ts";
    import {NilObj} from "./src/obj.ts";
    import {JoshLogger} from "./src/util.ts";
    import {eval_ast} from "./src/eval.ts";
    import {make_browser_scope} from "./src/browser.ts";

    let scope = make_browser_scope()

    const $ = (sel) => document.querySelector(sel)
    const on = (el,type,cb) => el.addEventListener(type,cb)
    const d = new JoshLogger()

    function output(last) {
        const li = document.createElement('li')
        console.log("typeof last is " + typeof last)
        console.log("typeof last is " + last instanceof Error)
        if (Error.isError(last)) {
            li.innerText = last.message
        } else if(last.is_kind_of('NumberProto')) {
            li.innerText = "Number: " + last._get_js_number()
        } else if(last.is_kind_of('StringProto')) {
            li.innerText = "String: " + last._get_js_string()
        } else {
            li.innerText = "Object: " + last.print()
        }
        const cons = $("#editor-console")
        cons.append(li)
        cons.scrollTop = cons.scrollHeight

    }
    function cval(code, scope) {
        d.disable()
        d.p('=========')
        d.p(`code is '${code}'`)
        let body = parseBlockBody(code);
        d.p('ast is', body.toString())
        try {
            let last = NilObj()
            if (Array.isArray(body)) {
                for (let ast of body) {
                    last = eval_ast(ast, scope)
                    if (!last) last = NilObj()
                }
            } else {
                last = eval_ast(body, scope);
            }
            if (last._is_return) last = last.get_slot('value');
            d.p("returned", last.print())
            output(last)
        } catch (e) {
            console.log("error happened",e.name, e.type,e.message)
            output(e)
        }
    }

    cval(`[
            dom ::= (DomProxy clone).
            dom init.
            button ::= (dom makeButton: "hi there").
            Debug print: 'here'.
            dom append: button.
            Global makeSlot "dom" dom.
        ] value.`,scope)

    on($("#repl"),'change',() => {
        // console.log("repl changed")
    })
    on($("#repl"),'input',(e) => {
        // console.log("repl input",e)
    })
    on($("#repl"),'keydown',(e) => {
        if(e.key === 'Enter' && e.metaKey) {
            const textArea = $("#repl")
            const selectionStart = textArea.selectionStart;
            const selectionEnd = textArea.selectionEnd;
            const selectedText = textArea.value.substring(selectionStart, selectionEnd);

            console.log("executing", selectedText)
            cval(selectedText, scope)
        }
    })
</script>
</body>
</html>